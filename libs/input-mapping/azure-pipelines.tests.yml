
jobs:
  - template: ../../azure-pipelines/jobs/lock.yml
    parameters:
      jobName: input_mapping_lock
      lockName: input-mapping-lock

  - template: ../../azure-pipelines/jobs/run-tests.yml
    parameters:
      jobName: cs
      displayName: Code Check
      serviceName: ci-input-mapping
      testCommand: composer check
      dependsOn: [input_mapping_lock]

  - template: ../../azure-pipelines/jobs/run-tests.yml
    parameters:
      jobName: aws_tests_php8_commonPart1
      dependsOn: [cs]
      displayName: Test on AWS backend CommonPart1
      serviceName: ci-input-mapping
      testCommand: vendor/bin/phpunit --testsuite CommonPart1
      variables:
        STORAGE_API_URL: $(STORAGE_API_URL_AWS)
        RUN_SYNAPSE_TESTS: 0
      secrets:
        STORAGE_API_TOKEN: $(INPUT_MAPPING__STORAGE_API_TOKEN_AWS)
        STORAGE_API_TOKEN_MASTER: $(INPUT_MAPPING__STORAGE_API_TOKEN_MASTER_AWS)

  - template: ../../azure-pipelines/jobs/run-tests.yml
    parameters:
      jobName: aws_tests_php8_aws_testsuite
      dependsOn: [ cs, aws_tests_php8_commonPart1 ]
      displayName: Test on AWS backend CommonPart1
      serviceName: ci-input-mapping
      testCommand: vendor/bin/phpunit --testsuite Aws
      variables:
        STORAGE_API_URL: $(STORAGE_API_URL_AWS)
        RUN_SYNAPSE_TESTS: 0
      secrets:
        STORAGE_API_TOKEN: $(INPUT_MAPPING__STORAGE_API_TOKEN_AWS)
        STORAGE_API_TOKEN_MASTER: $(INPUT_MAPPING__STORAGE_API_TOKEN_MASTER_AWS)

  - template: ../../azure-pipelines/jobs/run-tests.yml
    parameters:
      jobName: aws_tests_php8_commonPart2
      dependsOn: [cs]
      displayName: Common Tests (Part 2) on AWS backend
      serviceName: ci-input-mapping
      testCommand: vendor/bin/phpunit --testsuite CommonPart2
      variables:
        STORAGE_API_URL: $(STORAGE_API_URL_AWS)
        RUN_SYNAPSE_TESTS: 0
      secrets:
        STORAGE_API_TOKEN: $(INPUT_MAPPING__STORAGE_API_TOKEN_AWS)
        STORAGE_API_TOKEN_MASTER: $(INPUT_MAPPING__STORAGE_API_TOKEN_MASTER_AWS)

  - template: ../../azure-pipelines/jobs/run-tests.yml
    parameters:
      jobName: aws_tests_php8_commonFiles
      dependsOn: [cs]
      displayName: Files Tests on AWS backend
      serviceName: ci-input-mapping
      testCommand: vendor/bin/phpunit --testsuite CommonFiles
      variables:
        STORAGE_API_URL: $(STORAGE_API_URL_AWS)
        RUN_SYNAPSE_TESTS: 0
      secrets:
        STORAGE_API_TOKEN: $(INPUT_MAPPING__STORAGE_API_TOKEN_AWS)
        STORAGE_API_TOKEN_MASTER: $(INPUT_MAPPING__STORAGE_API_TOKEN_MASTER_AWS)

  - template: ../../azure-pipelines/jobs/run-tests.yml
    parameters:
      jobName: azure_tests_php8_commonPart1
      dependsOn: [cs]
      displayName: Run Common Test Suite (Part 1) on Azure
      serviceName: ci-input-mapping
      testCommand: vendor/bin/phpunit --testsuite CommonPart1
      variables:
        STORAGE_API_URL: $(STORAGE_API_URL_AZURE)
        RUN_SYNAPSE_TESTS: 0
      secrets:
        STORAGE_API_TOKEN: $(INPUT_MAPPING__STORAGE_API_TOKEN_AZURE)
        STORAGE_API_TOKEN_MASTER: $(INPUT_MAPPING__STORAGE_API_TOKEN_MASTER_AZURE)

  - template: ../../azure-pipelines/jobs/run-tests.yml
    parameters:
      jobName: azure_tests_php8_azure_testsuite
      dependsOn: [ cs, azure_tests_php8_commonPart1 ]
      displayName: Run Common Test Suite (Part 1) on Azure
      serviceName: ci-input-mapping
      testCommand: vendor/bin/phpunit --testsuite Azure
      variables:
        STORAGE_API_URL: $(STORAGE_API_URL_AZURE)
        RUN_SYNAPSE_TESTS: 0
      secrets:
        STORAGE_API_TOKEN: $(INPUT_MAPPING__STORAGE_API_TOKEN_AZURE)
        STORAGE_API_TOKEN_MASTER: $(INPUT_MAPPING__STORAGE_API_TOKEN_MASTER_AZURE)

  - template: ../../azure-pipelines/jobs/run-tests.yml
    parameters:
      jobName: azure_tests_php8_commonPart2
      dependsOn: [cs]
      displayName: Run Common Test Suite (Part 2) on Azure
      serviceName: ci-input-mapping
      testCommand: vendor/bin/phpunit --testsuite CommonPart2
      variables:
        STORAGE_API_URL: $(STORAGE_API_URL_AZURE)
        RUN_SYNAPSE_TESTS: 0
      secrets:
        STORAGE_API_TOKEN: $(INPUT_MAPPING__STORAGE_API_TOKEN_AZURE)
        STORAGE_API_TOKEN_MASTER: $(INPUT_MAPPING__STORAGE_API_TOKEN_MASTER_AZURE)

  - template: ../../azure-pipelines/jobs/run-tests.yml
    parameters:
      jobName: azure_tests_php8_commonFiles
      dependsOn: [cs]
      displayName: Run CommonFiles Test Suite on Azure
      serviceName: ci-input-mapping
      testCommand: vendor/bin/phpunit --testsuite CommonFiles
      variables:
        STORAGE_API_URL: $(STORAGE_API_URL_AZURE)
        RUN_SYNAPSE_TESTS: 0
      secrets:
        STORAGE_API_TOKEN: $(INPUT_MAPPING__STORAGE_API_TOKEN_AZURE)
        STORAGE_API_TOKEN_MASTER: $(INPUT_MAPPING__STORAGE_API_TOKEN_MASTER_AZURE)

  - template: ../../azure-pipelines/jobs/run-tests.yml
    parameters:
      jobName: azure_tests_php8_synapse
      dependsOn: [cs]
      displayName: Run Azure Testsuite on Azure with Synapse
      serviceName: ci-input-mapping
      testCommand: vendor/bin/phpunit --testsuite AzureSynapse
      variables:
        STORAGE_API_URL: $(STORAGE_API_URL_AZURE)
        RUN_SYNAPSE_TESTS: 1
      secrets:
        STORAGE_API_TOKEN: $(INPUT_MAPPING__STORAGE_API_TOKEN_AZURE)
        STORAGE_API_TOKEN_MASTER: $(INPUT_MAPPING__STORAGE_API_TOKEN_MASTER_AZURE)
        SYNAPSE_STORAGE_API_TOKEN: $(SYNAPSE_STORAGE_API_TOKEN)

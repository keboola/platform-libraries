pr: none
trigger:
  batch: true

pool:
  vmImage: ubuntu-latest

stages:
  - stage: PHP_56
    jobs:
      - job: tests
        displayName: 'Run tests'
        steps:
        - script: docker-compose build --pull tests56
          displayName: 'Build Tests image'

        - script: docker-compose run --rm tests56 composer phpcs
          displayName: 'CS Check'

        - script: docker-compose run --rm tests56 vendor/bin/phpunit
          displayName: 'Run Test Suite'
          env:
            STORAGE_API_TOKEN: $(STORAGE_API_TOKEN)
            STORAGE_API_TOKEN_MASTER: $(STORAGE_API_TOKEN_MASTER)
            STORAGE_API_URL: $(STORAGE_API_URL)
            RUN_SYNAPSE_TESTS: $(RUN_SYNAPSE_TESTS)
            SYNAPSE_STORAGE_API_TOKEN: $(SYNAPSE_STORAGE_API_TOKEN)
            SYNAPSE_STORAGE_API_URL: $(SYNAPSE_STORAGE_API_URL)

  - stage: PHP_74
    jobs:
      - job: tests
        displayName: 'Run tests'
        steps:
        - script: docker-compose build --pull tests74
          displayName: 'Build Tests image'

        - script: docker-compose run --rm tests74 composer phpcs
          displayName: 'CS Check'

        - script: docker-compose run --rm tests74 vendor/bin/phpunit
          displayName: 'Run Test Suite'
          env:
            STORAGE_API_TOKEN: $(STORAGE_API_TOKEN)
            STORAGE_API_TOKEN_MASTER: $(STORAGE_API_TOKEN_MASTER)
            STORAGE_API_URL: $(STORAGE_API_URL)
            RUN_SYNAPSE_TESTS: $(RUN_SYNAPSE_TESTS)
            SYNAPSE_STORAGE_API_TOKEN: $(SYNAPSE_STORAGE_API_TOKEN)
            SYNAPSE_STORAGE_API_URL: $(SYNAPSE_STORAGE_API_URL)
